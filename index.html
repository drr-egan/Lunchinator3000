<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunchinator 3000 - Team Lunch Ordering</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Lunchinator 3000</h1>
            <p class="subtitle">What does the team want for lunch today?</p>
            <button id="view-results-top" class="btn btn-secondary btn-top-nav" style="display: none;">
                üìä View Team Results
            </button>
        </header>

        <!-- Step 1: Collect Team Preferences -->
        <section id="preferences-section" class="section active">
            <h2>ü§ñ AI-Powered Lunch Finder</h2>
            <p class="ai-subtitle">Answer 5 questions and let AI find your perfect restaurant</p>

            <div class="form-group">
                <label for="name">1. What's your name?</label>
                <input type="text" id="name" placeholder="Enter your name" required>
            </div>

            <div class="form-group">
                <label for="food-type">2. What cuisine are you craving?</label>
                <select id="food-type">
                    <option value="">-- Select Cuisine --</option>
                    <option value="pizza">Pizza</option>
                    <option value="chinese">Chinese</option>
                    <option value="mexican">Mexican</option>
                    <option value="italian">Italian</option>
                    <option value="american">American/Burgers</option>
                    <option value="asian">Asian Fusion</option>
                    <option value="sandwich">Sandwiches/Subs</option>
                    <option value="indian">Indian</option>
                    <option value="thai">Thai</option>
                    <option value="mediterranean">Mediterranean</option>
                    <option value="japanese">Japanese/Sushi</option>
                    <option value="bbq">BBQ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="hunger-level">3. How hungry are you?</label>
                <select id="hunger-level">
                    <option value="">-- Select Hunger Level --</option>
                    <option value="light">Light - Small meal or snack</option>
                    <option value="moderate">Moderate - Regular meal</option>
                    <option value="very-hungry">Very Hungry - Large portions</option>
                </select>
            </div>

            <div class="form-group">
                <label for="flavor-preference">4. What flavors are you craving?</label>
                <select id="flavor-preference">
                    <option value="">-- Select Flavor --</option>
                    <option value="spicy">Spicy - Bring the heat!</option>
                    <option value="savory">Savory - Rich and hearty</option>
                    <option value="fresh">Fresh - Light and crisp</option>
                    <option value="sweet-savory">Sweet & Savory - Best of both</option>
                    <option value="mild">Mild - Keep it simple</option>
                </select>
            </div>

            <div class="form-group">
                <label for="mood">5. What's your mood/occasion?</label>
                <select id="mood">
                    <option value="">-- Select Mood --</option>
                    <option value="comfort">Comfort food - Something familiar and satisfying</option>
                    <option value="healthy">Healthy - Fresh and nutritious</option>
                    <option value="indulgent">Indulgent - Treat yourself, go big</option>
                    <option value="adventurous">Adventurous - Try something new</option>
                </select>
            </div>

            <button id="submit-preference" class="btn btn-primary">ü§ñ Find My Perfect Lunch</button>
        </section>

        <!-- Step 2: View Team Preferences -->
        <section id="results-section" class="section">
            <h2>Team Preferences</h2>
            <div id="preferences-list" class="preferences-list"></div>

            <div class="actions">
                <button id="find-restaurants" class="btn btn-primary">Find Nearby Restaurants</button>
                <button id="reset-preferences" class="btn btn-secondary">Clear All & Start Over</button>
            </div>
        </section>

        <!-- Step 3: Restaurant Results -->
        <section id="restaurants-section" class="section">
            <h2>Nearby Restaurants (within 15 miles)</h2>
            <div id="loading" class="loading" style="display: none;">
                <p>üîç Finding restaurants near Champlin, MN...</p>
            </div>
            <div id="restaurants-list" class="restaurants-list"></div>
            <button id="back-to-preferences" class="btn btn-secondary">Back to Preferences</button>
        </section>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA5l83Pwi_WDmWwJURvLEzn7FIDU1oxYu4",
          authDomain: "lunchinator3000.firebaseapp.com",
          projectId: "lunchinator3000",
          storageBucket: "lunchinator3000.firebasestorage.app",
          messagingSenderId: "919461112233",
          appId: "1:919461112233:web:613b22dc46767931adfcb8",
          measurementId: "G-VBJR219C8B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Constants
        const PREFERENCES_COLLECTION = 'lunch_preferences';
        const ORDERS_COLLECTION = 'lunch_orders';
        const DEFAULT_LOCATION = {
          lat: 45.1589,
          lng: -93.3954,
          address: "11611 Business Park Blvd N, Champlin, MN 55316",
          radius: 24140  // 15 miles in meters
        };

        // State
        let currentPreferences = [];

        // DOM Elements
        const preferencesSection = document.getElementById('preferences-section');
        const resultsSection = document.getElementById('results-section');
        const restaurantsSection = document.getElementById('restaurants-section');
        const nameInput = document.getElementById('name');
        const foodTypeSelect = document.getElementById('food-type');
        const hungerLevelSelect = document.getElementById('hunger-level');
        const flavorPreferenceSelect = document.getElementById('flavor-preference');
        const moodSelect = document.getElementById('mood');
        const submitPreferenceBtn = document.getElementById('submit-preference');
        const preferencesList = document.getElementById('preferences-list');
        const findRestaurantsBtn = document.getElementById('find-restaurants');
        const resetPreferencesBtn = document.getElementById('reset-preferences');
        const restaurantsList = document.getElementById('restaurants-list');
        const backToPreferencesBtn = document.getElementById('back-to-preferences');
        const loadingDiv = document.getElementById('loading');
        const viewResultsTopBtn = document.getElementById('view-results-top');

        // Initialize
        console.log('App initializing...');
        setupEventListeners();
        loadPreferences();
        showSection('preferences');
        console.log('App initialized successfully!');

        function setupEventListeners() {
            submitPreferenceBtn.addEventListener('click', submitPreference);
            findRestaurantsBtn.addEventListener('click', searchRestaurants);
            resetPreferencesBtn.addEventListener('click', resetPreferences);
            backToPreferencesBtn.addEventListener('click', () => showSection('results'));
            viewResultsTopBtn.addEventListener('click', () => showSection('results'));
        }

        function showSection(section) {
            preferencesSection.classList.remove('active');
            resultsSection.classList.remove('active');
            restaurantsSection.classList.remove('active');

            switch(section) {
                case 'preferences':
                    preferencesSection.classList.add('active');
                    break;
                case 'results':
                    resultsSection.classList.add('active');
                    loadPreferences();
                    break;
                case 'restaurants':
                    restaurantsSection.classList.add('active');
                    break;
            }
        }

        async function submitPreference() {
            console.log('Submit button clicked!');

            const name = nameInput.value.trim();
            const foodType = foodTypeSelect.value;
            const hungerLevel = hungerLevelSelect.value;
            const flavorPreference = flavorPreferenceSelect.value;
            const mood = moodSelect.value;

            console.log('Form values:', { name, foodType, hungerLevel, flavorPreference, mood });

            if (!name) {
                alert('Please tell us your name!');
                return;
            }
            if (!foodType) {
                alert('Please select what cuisine you\'re craving!');
                return;
            }
            if (!hungerLevel) {
                alert('Please tell us how hungry you are!');
                return;
            }
            if (!flavorPreference) {
                alert('Please tell us what flavors you\'re craving!');
                return;
            }
            if (!mood) {
                alert('Please select your mood/occasion!');
                return;
            }

            try {
                console.log('Attempting to save to Firestore...');
                await addDoc(collection(db, PREFERENCES_COLLECTION), {
                    name,
                    foodType,
                    hungerLevel,
                    flavorPreference,
                    mood,
                    timestamp: new Date()
                });

                console.log('Successfully saved to Firestore!');

                nameInput.value = '';
                foodTypeSelect.value = '';
                hungerLevelSelect.value = '';
                flavorPreferenceSelect.value = '';
                moodSelect.value = '';

                showSection('results');
            } catch (error) {
                console.error('Error adding preference:', error);
                alert(`Error saving preference: ${error.message}`);
            }
        }

        async function loadPreferences() {
            try {
                const q = query(collection(db, PREFERENCES_COLLECTION), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                currentPreferences = [];
                querySnapshot.forEach((doc) => {
                    currentPreferences.push({ id: doc.id, ...doc.data() });
                });

                // Show/hide the top "View Results" button
                if (currentPreferences.length > 0) {
                    viewResultsTopBtn.style.display = 'inline-block';
                } else {
                    viewResultsTopBtn.style.display = 'none';
                }

                displayPreferences();
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        function displayPreferences() {
            if (currentPreferences.length === 0) {
                preferencesList.innerHTML = '<p class="empty-state">No preferences yet. Be the first to add yours!</p>';
                return;
            }

            const foodTypeCounts = {};
            currentPreferences.forEach(pref => {
                foodTypeCounts[pref.foodType] = (foodTypeCounts[pref.foodType] || 0) + 1;
            });

            const sortedVotes = Object.entries(foodTypeCounts).sort((a, b) => b[1] - a[1]);
            const maxVotes = sortedVotes[0][1];
            const winners = sortedVotes.filter(([_, count]) => count === maxVotes);

            let html = '<div class="summary">';

            // Display winner(s) or tie
            if (winners.length > 1) {
                const tiedOptions = winners.map(([type, _]) => capitalizeFirst(type)).join(', ');
                html += `<h3>ü§ù TIE: ${tiedOptions} (${maxVotes} votes each)</h3>`;
            } else {
                html += `<h3>üèÜ Most Popular: ${capitalizeFirst(winners[0][0])} (${maxVotes} votes)</h3>`;
            }

            html += '</div>';

            // Add voting graph
            html += '<div class="voting-graph">';
            html += '<h3>Voting Breakdown</h3>';
            const totalVotes = currentPreferences.length;
            sortedVotes.forEach(([foodType, count]) => {
                const percentage = ((count / totalVotes) * 100).toFixed(1);
                html += `
                    <div class="vote-bar-container">
                        <div class="vote-label">
                            <span class="food-name">${capitalizeFirst(foodType)}</span>
                            <span class="vote-count">${count} vote${count !== 1 ? 's' : ''} (${percentage}%)</span>
                        </div>
                        <div class="vote-bar">
                            <div class="vote-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += '<div class="preferences-grid">';
            currentPreferences.forEach(pref => {
                html += `
                    <div class="preference-card">
                        <div class="preference-header">
                            <strong>${pref.name}</strong>
                            <button class="btn-delete" onclick="window.deletePreference('${pref.id}')">‚úï</button>
                        </div>
                        <div class="preference-body">
                            <p class="food-type">üç¥ ${capitalizeFirst(pref.foodType || 'unknown')}</p>
                            <p class="preference-detail">üçΩÔ∏è ${capitalizeFirst(pref.hungerLevel || pref.mealSize || 'moderate')} hunger</p>
                            <p class="preference-detail">üå∂Ô∏è ${capitalizeFirst(pref.flavorPreference || 'mild')} flavors</p>
                            <p class="preference-detail">‚ú® ${capitalizeFirst(pref.mood || pref.vibe || 'comfort')}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            preferencesList.innerHTML = html;
        }

        window.deletePreference = async function(id) {
            if (!confirm('Remove this preference?')) return;
            try {
                await deleteDoc(doc(db, PREFERENCES_COLLECTION, id));
                loadPreferences();
            } catch (error) {
                console.error('Error deleting preference:', error);
                alert('Error deleting preference.');
            }
        };

        async function resetPreferences() {
            if (!confirm('Clear all preferences and start over?')) return;
            try {
                const querySnapshot = await getDocs(collection(db, PREFERENCES_COLLECTION));
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, PREFERENCES_COLLECTION, document.id)));
                });
                await Promise.all(deletePromises);
                currentPreferences = [];
                displayPreferences();
                showSection('preferences');
            } catch (error) {
                console.error('Error resetting preferences:', error);
                alert('Error clearing preferences.');
            }
        }

        async function searchRestaurants() {
            if (currentPreferences.length === 0) {
                alert('Add some preferences first!');
                return;
            }

            showSection('restaurants');
            loadingDiv.style.display = 'block';
            restaurantsList.innerHTML = '';

            const foodTypeCounts = {};
            currentPreferences.forEach(pref => {
                foodTypeCounts[pref.foodType] = (foodTypeCounts[pref.foodType] || 0) + 1;
            });

            // Check for ties
            const sortedVotes = Object.entries(foodTypeCounts).sort((a, b) => b[1] - a[1]);
            const maxVotes = sortedVotes[0][1];
            const tiedTypes = sortedVotes.filter(([_, count]) => count === maxVotes).map(([type, _]) => type);

            const isTie = tiedTypes.length > 1;
            const searchTypes = isTie ? tiedTypes : [sortedVotes[0][0]];

            try {
                // Call Cloud Function to get real restaurant data (100% free using OpenStreetMap)
                // Pass all preferences for AI-powered matching
                const searchRestaurantsFunc = httpsCallable(functions, 'searchRestaurants');

                // If tie, search all tied types and combine results
                let allRestaurants = [];
                for (const foodType of searchTypes) {
                    const result = await searchRestaurantsFunc({
                        foodType: foodType,
                        lat: DEFAULT_LOCATION.lat,
                        lng: DEFAULT_LOCATION.lng,
                        radius: DEFAULT_LOCATION.radius,
                        preferences: currentPreferences
                    });
                    if (result.data.restaurants) {
                        allRestaurants = allRestaurants.concat(result.data.restaurants);
                    }
                }

                const result = { data: { restaurants: allRestaurants } };

                let restaurants = result.data.restaurants;

                if (restaurants && restaurants.length > 0) {
                    // Sort restaurants by distance (nearest to farthest)
                    restaurants = sortRestaurantsByDistance(restaurants);
                    displayRestaurants(restaurants, isTie, tiedTypes);
                } else {
                    // No restaurants found
                    console.log('No restaurants found');
                    displayNoResults(searchTypes.join(', '));
                }
            } catch (error) {
                console.error('Error searching restaurants:', error);
                displayError(error.message);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function sortRestaurantsByDistance(restaurants) {
            return restaurants.sort((a, b) => {
                // Parse distance strings like "3.2 miles" to numbers
                const distanceA = parseFloat(a.distance);
                const distanceB = parseFloat(b.distance);
                return distanceA - distanceB;
            });
        }

        function displayNoResults(foodType) {
            restaurantsList.innerHTML = `
                <div class="no-results">
                    <h3>üòî No ${capitalizeFirst(foodType)} Restaurants Found</h3>
                    <p>We couldn't find any ${foodType} restaurants within 15 miles of your location using OpenStreetMap data.</p>
                    <p><strong>Suggestions:</strong></p>
                    <ul>
                        <li>Try selecting a different cuisine type</li>
                        <li>Check if the team voted for other food types</li>
                        <li>Use Google Maps or Yelp to search manually</li>
                    </ul>
                    <button class="btn btn-secondary" onclick="location.reload()">Start Over</button>
                </div>
            `;
        }

        function displayError(errorMessage) {
            restaurantsList.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Error Loading Restaurants</h3>
                    <p>There was a problem searching for restaurants: ${errorMessage}</p>
                    <p><strong>What you can do:</strong></p>
                    <ul>
                        <li>Check your internet connection</li>
                        <li>Try again in a few moments</li>
                        <li>If the problem persists, use Google Maps or Yelp to search manually</li>
                    </ul>
                    <button class="btn btn-secondary" onclick="window.location.reload()">Try Again</button>
                </div>
            `;
        }

        function displayRestaurants(restaurants, isTie, tiedTypes) {
            let html = '';

            if (isTie && tiedTypes) {
                const tiedNames = tiedTypes.map(t => capitalizeFirst(t)).join(', ');
                html += `
                    <div class="tie-breaker-message">
                        <h3>ü§ù Tie Detected: ${tiedNames}</h3>
                        <p>We searched all tied options and used AI to find the best compromise based on everyone's preferences.</p>
                        <p><strong>Showing top matches ranked by team preferences:</strong></p>
                    </div>
                `;
            } else {
                html += `<h3>üçΩÔ∏è Top Recommended Restaurants</h3>`;
            }

            html += '<div class="restaurants-grid">';
            restaurants.forEach((restaurant, index) => {
                html += `
                    <div class="restaurant-card">
                        <h4>${restaurant.name}</h4>
                        <p class="address">üìç ${restaurant.address}</p>
                        <p class="distance">üìè ${restaurant.distance}</p>
                        <div class="restaurant-details">
                            <span class="rating">‚≠ê ${restaurant.rating}</span>
                            <span class="price">${restaurant.priceLevel}</span>
                            ${restaurant.takeout ? '<span class="takeout-badge">ü•° Takeout Available</span>' : ''}
                        </div>
                `;

                // Add AI-generated explanation if available
                if (restaurant.aiExplanation) {
                    const ai = restaurant.aiExplanation;

                    // Check if this is a "not enough data" case
                    const hasData = ai.perPersonMatches && ai.perPersonMatches.length > 0;

                    if (!hasData && ai.teamConsensus.includes("Not enough data")) {
                        // Show minimal message for restaurants without cached data
                        html += `
                            <div class="ai-explanation no-data">
                                <div class="ai-section">
                                    <h5>ü§ñ AI Analysis</h5>
                                    <p class="no-data-message">${ai.teamConsensus}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Show full AI analysis for restaurants with cached data
                        html += `
                            <div class="ai-explanation">
                                <div class="ai-section">
                                    <h5>ü§ñ AI Analysis</h5>
                                    <p class="team-consensus">${ai.teamConsensus}</p>
                                </div>

                                <button class="expand-btn" onclick="toggleDetails(${index})">
                                    <span id="toggle-text-${index}">Show Detailed Analysis</span>
                                </button>

                                <div class="ai-details" id="ai-details-${index}">
                                    ${ai.perPersonMatches && ai.perPersonMatches.length > 0 ? `
                                        <div class="ai-section">
                                            <h6>üë• Personal Matches</h6>
                                            <ul class="person-matches">
                                                ${ai.perPersonMatches.map(match => `
                                                    <li><strong>${match.name}:</strong> ${match.match}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}

                                    ${ai.conflicts && ai.conflicts.length > 0 ? `
                                        <div class="ai-section conflicts">
                                            <h6>‚ö†Ô∏è Considerations</h6>
                                            <ul>
                                                ${ai.conflicts.map(conflict => `<li>${conflict}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}

                                    ${ai.dietaryInsights ? `
                                        <div class="ai-section">
                                            <h6>üç¥ Menu Suggestions</h6>
                                            <p>${ai.dietaryInsights}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                }

                html += `
                        <button class="btn btn-primary" onclick="window.selectRestaurant('${restaurant.name}', '${restaurant.address}')">
                            Choose This Restaurant
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            restaurantsList.innerHTML = html;
        }

        window.selectRestaurant = async function(name, address) {
            try {
                await addDoc(collection(db, ORDERS_COLLECTION), {
                    restaurantName: name,
                    restaurantAddress: address,
                    timestamp: new Date(),
                    preferences: currentPreferences
                });
                alert(`Great! The team will order from ${name}`);
                showSection('results');
            } catch (error) {
                console.error('Error saving restaurant selection:', error);
                alert('Error saving selection.');
            }
        };

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Toggle AI details visibility
        window.toggleDetails = function(index) {
            const detailsDiv = document.getElementById(`ai-details-${index}`);
            const toggleText = document.getElementById(`toggle-text-${index}`);

            if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
                detailsDiv.style.display = 'block';
                toggleText.textContent = 'Hide Detailed Analysis';
            } else {
                detailsDiv.style.display = 'none';
                toggleText.textContent = 'Show Detailed Analysis';
            }
        };
    </script>
</body>
</html>
