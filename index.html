<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunchinator 3000 - Team Lunch Ordering</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Lunchinator 3000</h1>
            <p class="subtitle">What does the team want for lunch today?</p>
        </header>

        <!-- Step 1: Collect Team Preferences -->
        <section id="preferences-section" class="section active">
            <h2>ü§ñ AI-Powered Lunch Finder</h2>
            <p class="ai-subtitle">Answer 5 questions and let AI find your perfect restaurant</p>

            <div class="form-group">
                <label for="name">1. What's your name?</label>
                <input type="text" id="name" placeholder="Enter your name" required>
            </div>

            <div class="form-group">
                <label for="food-type">2. What cuisine are you craving?</label>
                <select id="food-type">
                    <option value="">-- Select Cuisine --</option>
                    <option value="pizza">Pizza</option>
                    <option value="chinese">Chinese</option>
                    <option value="mexican">Mexican</option>
                    <option value="italian">Italian</option>
                    <option value="american">American/Burgers</option>
                    <option value="asian">Asian Fusion</option>
                    <option value="sandwich">Sandwiches/Subs</option>
                    <option value="indian">Indian</option>
                    <option value="thai">Thai</option>
                    <option value="mediterranean">Mediterranean</option>
                    <option value="japanese">Japanese/Sushi</option>
                    <option value="bbq">BBQ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="hunger-level">3. How hungry are you?</label>
                <select id="hunger-level">
                    <option value="">-- Select Hunger Level --</option>
                    <option value="light">Light - Small meal or snack</option>
                    <option value="moderate">Moderate - Regular meal</option>
                    <option value="very-hungry">Very Hungry - Large portions</option>
                </select>
            </div>

            <div class="form-group">
                <label for="flavor-preference">4. What flavors are you craving?</label>
                <select id="flavor-preference">
                    <option value="">-- Select Flavor --</option>
                    <option value="spicy">Spicy - Bring the heat!</option>
                    <option value="savory">Savory - Rich and hearty</option>
                    <option value="fresh">Fresh - Light and crisp</option>
                    <option value="sweet-savory">Sweet & Savory - Best of both</option>
                    <option value="mild">Mild - Keep it simple</option>
                </select>
            </div>

            <div class="form-group">
                <label for="mood">5. What's your mood/occasion?</label>
                <select id="mood">
                    <option value="">-- Select Mood --</option>
                    <option value="comfort">Comfort food - Something familiar and satisfying</option>
                    <option value="healthy">Healthy - Fresh and nutritious</option>
                    <option value="indulgent">Indulgent - Treat yourself, go big</option>
                    <option value="adventurous">Adventurous - Try something new</option>
                    <option value="team">Team meal - Good for groups</option>
                </select>
            </div>

            <button id="submit-preference" class="btn btn-primary">ü§ñ Find My Perfect Lunch</button>
        </section>

        <!-- Step 2: View Team Preferences -->
        <section id="results-section" class="section">
            <h2>Team Preferences</h2>
            <div id="preferences-list" class="preferences-list"></div>

            <div class="actions">
                <button id="find-restaurants" class="btn btn-primary">Find Nearby Restaurants</button>
                <button id="reset-preferences" class="btn btn-secondary">Clear All & Start Over</button>
            </div>
        </section>

        <!-- Step 3: Restaurant Results -->
        <section id="restaurants-section" class="section">
            <h2>Nearby Restaurants (within 15 miles)</h2>
            <div id="loading" class="loading" style="display: none;">
                <p>üîç Finding restaurants near Champlin, MN...</p>
            </div>
            <div id="restaurants-list" class="restaurants-list"></div>
            <button id="back-to-preferences" class="btn btn-secondary">Back to Preferences</button>
        </section>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA5l83Pwi_WDmWwJURvLEzn7FIDU1oxYu4",
          authDomain: "lunchinator3000.firebaseapp.com",
          projectId: "lunchinator3000",
          storageBucket: "lunchinator3000.firebasestorage.app",
          messagingSenderId: "919461112233",
          appId: "1:919461112233:web:613b22dc46767931adfcb8",
          measurementId: "G-VBJR219C8B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Constants
        const PREFERENCES_COLLECTION = 'lunch_preferences';
        const ORDERS_COLLECTION = 'lunch_orders';
        const GOOGLE_PLACES_API_KEY = "AIzaSyCNq6Xtlr1kvPXl20qlu0p1ND9bjiP5eRA";
        const DEFAULT_LOCATION = {
          lat: 45.1589,
          lng: -93.3954,
          address: "11611 Business Park Blvd N, Champlin, MN 55316",
          radius: 24140
        };

        // State
        let currentPreferences = [];

        // DOM Elements
        const preferencesSection = document.getElementById('preferences-section');
        const resultsSection = document.getElementById('results-section');
        const restaurantsSection = document.getElementById('restaurants-section');
        const nameInput = document.getElementById('name');
        const foodTypeSelect = document.getElementById('food-type');
        const hungerLevelSelect = document.getElementById('hunger-level');
        const flavorPreferenceSelect = document.getElementById('flavor-preference');
        const moodSelect = document.getElementById('mood');
        const submitPreferenceBtn = document.getElementById('submit-preference');
        const preferencesList = document.getElementById('preferences-list');
        const findRestaurantsBtn = document.getElementById('find-restaurants');
        const resetPreferencesBtn = document.getElementById('reset-preferences');
        const restaurantsList = document.getElementById('restaurants-list');
        const backToPreferencesBtn = document.getElementById('back-to-preferences');
        const loadingDiv = document.getElementById('loading');

        // Initialize
        console.log('App initializing...');
        setupEventListeners();
        loadPreferences();
        showSection('preferences');
        console.log('App initialized successfully!');

        function setupEventListeners() {
            submitPreferenceBtn.addEventListener('click', submitPreference);
            findRestaurantsBtn.addEventListener('click', searchRestaurants);
            resetPreferencesBtn.addEventListener('click', resetPreferences);
            backToPreferencesBtn.addEventListener('click', () => showSection('results'));
        }

        function showSection(section) {
            preferencesSection.classList.remove('active');
            resultsSection.classList.remove('active');
            restaurantsSection.classList.remove('active');

            switch(section) {
                case 'preferences':
                    preferencesSection.classList.add('active');
                    break;
                case 'results':
                    resultsSection.classList.add('active');
                    loadPreferences();
                    break;
                case 'restaurants':
                    restaurantsSection.classList.add('active');
                    break;
            }
        }

        async function submitPreference() {
            console.log('Submit button clicked!');

            const name = nameInput.value.trim();
            const foodType = foodTypeSelect.value;
            const hungerLevel = hungerLevelSelect.value;
            const flavorPreference = flavorPreferenceSelect.value;
            const mood = moodSelect.value;

            console.log('Form values:', { name, foodType, hungerLevel, flavorPreference, mood });

            if (!name) {
                alert('Please tell us your name!');
                return;
            }
            if (!foodType) {
                alert('Please select what cuisine you\'re craving!');
                return;
            }
            if (!hungerLevel) {
                alert('Please tell us how hungry you are!');
                return;
            }
            if (!flavorPreference) {
                alert('Please tell us what flavors you\'re craving!');
                return;
            }
            if (!mood) {
                alert('Please select your mood/occasion!');
                return;
            }

            try {
                console.log('Attempting to save to Firestore...');
                await addDoc(collection(db, PREFERENCES_COLLECTION), {
                    name,
                    foodType,
                    hungerLevel,
                    flavorPreference,
                    mood,
                    timestamp: new Date()
                });

                console.log('Successfully saved to Firestore!');

                nameInput.value = '';
                foodTypeSelect.value = '';
                hungerLevelSelect.value = '';
                flavorPreferenceSelect.value = '';
                moodSelect.value = '';

                showSection('results');
            } catch (error) {
                console.error('Error adding preference:', error);
                alert(`Error saving preference: ${error.message}`);
            }
        }

        async function loadPreferences() {
            try {
                const q = query(collection(db, PREFERENCES_COLLECTION), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                currentPreferences = [];
                querySnapshot.forEach((doc) => {
                    currentPreferences.push({ id: doc.id, ...doc.data() });
                });

                displayPreferences();
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        function displayPreferences() {
            if (currentPreferences.length === 0) {
                preferencesList.innerHTML = '<p class="empty-state">No preferences yet. Be the first to add yours!</p>';
                return;
            }

            const foodTypeCounts = {};
            currentPreferences.forEach(pref => {
                foodTypeCounts[pref.foodType] = (foodTypeCounts[pref.foodType] || 0) + 1;
            });

            const sortedVotes = Object.entries(foodTypeCounts).sort((a, b) => b[1] - a[1]);
            const maxVotes = sortedVotes[0][1];
            const winners = sortedVotes.filter(([_, count]) => count === maxVotes);

            let html = '<div class="summary">';

            // Display winner(s) or tie
            if (winners.length > 1) {
                const tiedOptions = winners.map(([type, _]) => capitalizeFirst(type)).join(', ');
                html += `<h3>ü§ù TIE: ${tiedOptions} (${maxVotes} votes each)</h3>`;
            } else {
                html += `<h3>üèÜ Most Popular: ${capitalizeFirst(winners[0][0])} (${maxVotes} votes)</h3>`;
            }

            html += '</div>';

            // Add voting graph
            html += '<div class="voting-graph">';
            html += '<h3>Voting Breakdown</h3>';
            const totalVotes = currentPreferences.length;
            sortedVotes.forEach(([foodType, count]) => {
                const percentage = ((count / totalVotes) * 100).toFixed(1);
                html += `
                    <div class="vote-bar-container">
                        <div class="vote-label">
                            <span class="food-name">${capitalizeFirst(foodType)}</span>
                            <span class="vote-count">${count} vote${count !== 1 ? 's' : ''} (${percentage}%)</span>
                        </div>
                        <div class="vote-bar">
                            <div class="vote-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += '<div class="preferences-grid">';
            currentPreferences.forEach(pref => {
                html += `
                    <div class="preference-card">
                        <div class="preference-header">
                            <strong>${pref.name}</strong>
                            <button class="btn-delete" onclick="window.deletePreference('${pref.id}')">‚úï</button>
                        </div>
                        <div class="preference-body">
                            <p class="food-type">üç¥ ${capitalizeFirst(pref.foodType)}</p>
                            <p class="preference-detail">üçΩÔ∏è ${capitalizeFirst(pref.hungerLevel)} hunger</p>
                            <p class="preference-detail">üå∂Ô∏è ${capitalizeFirst(pref.flavorPreference)} flavors</p>
                            <p class="preference-detail">‚ú® ${capitalizeFirst(pref.mood)}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            preferencesList.innerHTML = html;
        }

        window.deletePreference = async function(id) {
            if (!confirm('Remove this preference?')) return;
            try {
                await deleteDoc(doc(db, PREFERENCES_COLLECTION, id));
                loadPreferences();
            } catch (error) {
                console.error('Error deleting preference:', error);
                alert('Error deleting preference.');
            }
        };

        async function resetPreferences() {
            if (!confirm('Clear all preferences and start over?')) return;
            try {
                const querySnapshot = await getDocs(collection(db, PREFERENCES_COLLECTION));
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, PREFERENCES_COLLECTION, document.id)));
                });
                await Promise.all(deletePromises);
                currentPreferences = [];
                displayPreferences();
                showSection('preferences');
            } catch (error) {
                console.error('Error resetting preferences:', error);
                alert('Error clearing preferences.');
            }
        }

        async function searchRestaurants() {
            if (currentPreferences.length === 0) {
                alert('Add some preferences first!');
                return;
            }

            showSection('restaurants');
            loadingDiv.style.display = 'block';
            restaurantsList.innerHTML = '';

            const foodTypeCounts = {};
            currentPreferences.forEach(pref => {
                foodTypeCounts[pref.foodType] = (foodTypeCounts[pref.foodType] || 0) + 1;
            });
            const mostPopularType = Object.entries(foodTypeCounts).sort((a, b) => b[1] - a[1])[0][0];

            try {
                // Call Cloud Function to get real restaurant data (100% free using OpenStreetMap)
                // Pass all preferences for AI-powered matching
                const searchRestaurantsFunc = httpsCallable(functions, 'searchRestaurants');
                const result = await searchRestaurantsFunc({
                    foodType: mostPopularType,
                    lat: DEFAULT_LOCATION.lat,
                    lng: DEFAULT_LOCATION.lng,
                    radius: DEFAULT_LOCATION.radius,
                    preferences: currentPreferences
                });

                let restaurants = result.data.restaurants;

                if (restaurants && restaurants.length > 0) {
                    // Sort restaurants by distance (nearest to farthest)
                    restaurants = sortRestaurantsByDistance(restaurants);
                    displayRestaurants(restaurants, mostPopularType);
                } else {
                    // Fallback to mock data if no results
                    console.log('No real restaurants found, using mock data');
                    let mockRestaurants = getMockRestaurants(mostPopularType);
                    mockRestaurants = sortRestaurantsByDistance(mockRestaurants);
                    displayRestaurants(mockRestaurants, mostPopularType);
                }
            } catch (error) {
                console.error('Error searching restaurants:', error);
                // Fallback to mock data on error
                console.log('Using mock data due to error');
                let mockRestaurants = getMockRestaurants(mostPopularType);
                mockRestaurants = sortRestaurantsByDistance(mockRestaurants);
                displayRestaurants(mockRestaurants, mostPopularType);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function sortRestaurantsByDistance(restaurants) {
            return restaurants.sort((a, b) => {
                // Parse distance strings like "3.2 miles" to numbers
                const distanceA = parseFloat(a.distance);
                const distanceB = parseFloat(b.distance);
                return distanceA - distanceB;
            });
        }

        function getMockRestaurants(foodType) {
            const mockData = {
                pizza: [
                    { name: "Pizza Ranch", address: "12516 Elm Creek Blvd N, Maple Grove, MN", rating: 4.2, priceLevel: "$$", distance: "3.2 miles", takeout: true },
                    { name: "Papa Murphy's", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$", distance: "2.8 miles", takeout: true },
                    { name: "Domino's Pizza", address: "11471 Fountains Dr, Maple Grove, MN", rating: 3.8, priceLevel: "$", distance: "4.1 miles", takeout: true }
                ],
                chinese: [
                    { name: "Hunan Garden", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.3, priceLevel: "$$", distance: "3.5 miles", takeout: true },
                    { name: "Great Hunan", address: "12920 Elm Creek Blvd N, Maple Grove, MN", rating: 4.1, priceLevel: "$$", distance: "4.2 miles", takeout: true },
                    { name: "Panda Express", address: "12447 Elm Creek Blvd, Maple Grove, MN", rating: 3.9, priceLevel: "$", distance: "3.1 miles", takeout: true }
                ],
                mexican: [
                    { name: "Chipotle Mexican Grill", address: "12447 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$$", distance: "3.1 miles", takeout: true },
                    { name: "Qdoba Mexican Eats", address: "7800 Main St N, Maple Grove, MN", rating: 3.9, priceLevel: "$$", distance: "5.8 miles", takeout: true },
                    { name: "Taco Bell", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 3.7, priceLevel: "$", distance: "3.5 miles", takeout: true }
                ],
                italian: [
                    { name: "Buca di Beppo", address: "7711 Mitchell Rd, Eden Prairie, MN", rating: 4.1, priceLevel: "$$", distance: "8.2 miles", takeout: true },
                    { name: "Olive Garden", address: "12516 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$$", distance: "3.2 miles", takeout: true },
                    { name: "Carbone's Pizzeria", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 4.3, priceLevel: "$$", distance: "2.9 miles", takeout: true }
                ],
                american: [
                    { name: "Five Guys", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.3, priceLevel: "$$", distance: "3.5 miles", takeout: true },
                    { name: "Culver's", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 4.4, priceLevel: "$$", distance: "2.9 miles", takeout: true },
                    { name: "Red Robin", address: "7935 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$$", distance: "5.1 miles", takeout: true }
                ],
                asian: [
                    { name: "P.F. Chang's", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.2, priceLevel: "$$$", distance: "3.5 miles", takeout: true },
                    { name: "Benihana", address: "7600 W 78th St, Bloomington, MN", rating: 4.1, priceLevel: "$$$", distance: "11.2 miles", takeout: true },
                    { name: "Pei Wei", address: "12920 Elm Creek Blvd, Maple Grove, MN", rating: 3.9, priceLevel: "$$", distance: "4.2 miles", takeout: true }
                ],
                sandwich: [
                    { name: "Jimmy John's", address: "12447 Elm Creek Blvd, Maple Grove, MN", rating: 4.1, priceLevel: "$", distance: "3.1 miles", takeout: true },
                    { name: "Subway", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 3.8, priceLevel: "$", distance: "2.8 miles", takeout: true },
                    { name: "Firehouse Subs", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.2, priceLevel: "$$", distance: "3.5 miles", takeout: true }
                ],
                indian: [
                    { name: "Taste of India", address: "7515 Main St N, Maple Grove, MN", rating: 4.4, priceLevel: "$$", distance: "6.1 miles", takeout: true },
                    { name: "India Palace", address: "8505 Edinburgh Center Dr, Brooklyn Park, MN", rating: 4.2, priceLevel: "$$", distance: "7.3 miles", takeout: true },
                    { name: "Tandoor", address: "8371 Highway 7, St Louis Park, MN", rating: 4.3, priceLevel: "$$", distance: "9.8 miles", takeout: true }
                ],
                thai: [
                    { name: "Thai Basil", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.3, priceLevel: "$$", distance: "3.5 miles", takeout: true },
                    { name: "Sawatdee", address: "7885 Main St N, Maple Grove, MN", rating: 4.1, priceLevel: "$$", distance: "5.9 miles", takeout: true },
                    { name: "Thai Garden", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$$", distance: "2.8 miles", takeout: true }
                ],
                mediterranean: [
                    { name: "Naf Naf Grill", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.2, priceLevel: "$$", distance: "3.5 miles", takeout: true },
                    { name: "Crave", address: "12920 Elm Creek Blvd, Maple Grove, MN", rating: 4.3, priceLevel: "$$$", distance: "4.2 miles", takeout: true },
                    { name: "Mediterranean Cruise Cafe", address: "7515 Main St N, Maple Grove, MN", rating: 4.4, priceLevel: "$$", distance: "6.1 miles", takeout: true }
                ],
                japanese: [
                    { name: "Kobe Japanese Steakhouse", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.2, priceLevel: "$$$", distance: "3.5 miles", takeout: true },
                    { name: "Osaka Sushi & Hibachi", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 4.1, priceLevel: "$$", distance: "2.9 miles", takeout: true },
                    { name: "Masu Sushi", address: "7711 Mitchell Rd, Eden Prairie, MN", rating: 4.4, priceLevel: "$$$", distance: "8.2 miles", takeout: true }
                ],
                bbq: [
                    { name: "Famous Dave's", address: "12544 Elm Creek Blvd, Maple Grove, MN", rating: 4.0, priceLevel: "$$", distance: "3.5 miles", takeout: true },
                    { name: "Dickey's Barbecue Pit", address: "11905 Elm Creek Blvd, Maple Grove, MN", rating: 3.9, priceLevel: "$$", distance: "2.8 miles", takeout: true },
                    { name: "Smoke in the Pit", address: "7515 Main St N, Maple Grove, MN", rating: 4.3, priceLevel: "$$", distance: "6.1 miles", takeout: true }
                ]
            };
            return mockData[foodType] || [];
        }

        function displayRestaurants(restaurants, foodType) {
            let html = `<h3>üçΩÔ∏è ${capitalizeFirst(foodType)} Restaurants Near You</h3>`;
            html += '<div class="restaurants-grid">';
            restaurants.forEach(restaurant => {
                html += `
                    <div class="restaurant-card">
                        <h4>${restaurant.name}</h4>
                        <p class="address">üìç ${restaurant.address}</p>
                        <p class="distance">üìè ${restaurant.distance}</p>
                        <div class="restaurant-details">
                            <span class="rating">‚≠ê ${restaurant.rating}</span>
                            <span class="price">${restaurant.priceLevel}</span>
                            ${restaurant.takeout ? '<span class="takeout-badge">ü•° Takeout Available</span>' : ''}
                        </div>
                        <button class="btn btn-primary" onclick="window.selectRestaurant('${restaurant.name}', '${restaurant.address}')">
                            Choose This Restaurant
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            restaurantsList.innerHTML = html;
        }

        window.selectRestaurant = async function(name, address) {
            try {
                await addDoc(collection(db, ORDERS_COLLECTION), {
                    restaurantName: name,
                    restaurantAddress: address,
                    timestamp: new Date(),
                    preferences: currentPreferences
                });
                alert(`Great! The team will order from ${name}`);
                showSection('results');
            } catch (error) {
                console.error('Error saving restaurant selection:', error);
                alert('Error saving selection.');
            }
        };

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>
